# Collection Governance

## üéØ Purpose

This document defines governance rules for Qdrant collections in the Hish framework, including immutability policies, update procedures, and access controls.

---

## üìö Collection Types

### **1. Framework Collections (READ-ONLY)**

**Collections:**
- `hish_framework_mpnet` - Framework documentation, agent directives, templates
- Any collection matching `*_framework_*` pattern

**Characteristics:**
- ‚úÖ **Read-only at runtime** - Agents cannot write to these collections
- ‚úÖ **Source-controlled** - Built from markdown files in git repositories
- ‚úÖ **Reproducible** - Can be rebuilt at any time via `make index-framework`
- ‚úÖ **Version-controlled** - Changes tracked through git commits

**Update Procedure:**
1. Edit markdown files in the repository
2. Commit changes to git
3. Run `make index-framework` to rebuild collection
4. Framework collection reflects new content

**Enforcement:**
- `beforeMCPExecution` hook blocks `qdrant-store` calls to framework collections
- Agent receives clear error message with guidance to use `cross_project_intelligence`

**Why Read-Only?**
- Ensures framework documentation consistency
- Prevents accidental corruption of curated content
- Enables easy rollback via git + reindex
- Separates "source of truth" (markdown) from "search index" (Qdrant)

---

### **2. Cross-Project Intelligence Collection (WRITABLE)**

**Collection:**
- `cross_project_intelligence` - Agent-curated patterns, learnings, taxonomies

**Characteristics:**
- ‚úÖ **Writable at runtime** - Agents can store patterns (with user approval)
- ‚úÖ **Curated knowledge** - Not reproducible from source files
- ‚úÖ **Unique value** - Contains extracted patterns and learnings
- ‚ö†Ô∏è **Requires backup** - Cannot be easily reconstructed

**Storage Workflow:**
1. Agent identifies reusable pattern
2. Documents pattern using taxonomy (see `templates/pattern-taxonomy-guide.md`)
3. Presents to user for review and approval
4. Only after approval: `qdrant-store` to `cross_project_intelligence`
5. Pattern becomes discoverable across all projects

**Storage Requirements:**
- User must explicitly approve storage
- Pattern must follow taxonomy structure
- Must include evidence and validation
- Must have clear cross-project applicability

**Backup Strategy:**
```bash
# Backup intelligence collection
make backup  # Creates tar.gz of .data/qdrant/

# Scheduled backup (recommended: daily cron job)
0 2 * * * cd /path/to/hish && make backup
```

---

### **3. Project Documentation Collections (READ-ONLY)**

**Collections:**
- `{project}_docs_mpnet` - Project-specific documentation, AGENTS.md synopses

**Characteristics:**
- ‚úÖ **Read-only at runtime** - Rebuilt from project markdown files
- ‚úÖ **Project-specific** - Contains context for one project
- ‚úÖ **Includes synopses** - AGENTS.md file synopses generated by agent

**Update Procedure:**
1. Edit project documentation markdown files
2. For AGENTS.md changes: Agent regenerates synopsis on next initialization
3. Run `make index` to rebuild all project collections
4. Project documentation collection reflects new content

**Synopsis Generation:**
- Agent scans for AGENTS.md files during initialization
- Generates/updates synopses in `local/{project}/agents_synopsis.md`
- Hash-based change detection prevents unnecessary regeneration
- Synopses get indexed into `{project}_docs_mpnet` collection

---

## üîí Access Control

### **Runtime Write Protection**

**Hook:** `.cursor/hooks/protect_framework_collection`

**Behavior:**
- Intercepts all `qdrant-store` MCP calls via `beforeMCPExecution` hook
- Checks collection name against framework patterns
- Blocks writes to framework collections with clear error message
- Allows writes to `cross_project_intelligence` collection
- Allows all read operations (`qdrant-find`)

**Error Message:**
```
‚ùå WRITE BLOCKED: Collection 'hish_framework_mpnet' is READ-ONLY.

Framework collections are rebuilt from markdown sources via 'make index-framework'.
They cannot be modified at runtime to ensure consistency.

‚úÖ USE THIS INSTEAD:
   Collection: cross_project_intelligence
   Purpose: Agent-curated patterns, learnings, and taxonomies

Example:
   qdrant-store "your pattern documentation" cross_project_intelligence <uuid>

See templates/pattern-taxonomy-guide.md for storage guidelines.
```

---

## üìä Collection Lifecycle

### **Framework Collection Updates**

**Trigger:** Documentation changes in repository
**Frequency:** On-demand (after doc changes)
**Command:** `make index-framework`
**Duration:** Fast (~seconds for typical framework docs)
**Safety:** Non-destructive (preserves existing data)

### **Project Collection Updates**

**Trigger:** Project documentation changes or AGENTS.md modifications
**Frequency:** On-demand (after doc changes or quarterly review)
**Command:** `make index` (all projects) or `make index-repo REPO=project-name` (specific)
**Duration:** Depends on project size
**Safety:** Non-destructive (preserves existing data)

### **Intelligence Collection Curation**

**Trigger:** User-approved pattern storage
**Frequency:** Continuous (as patterns discovered)
**Command:** Agent uses `qdrant-store` (with approval)
**Duration:** Instant
**Safety:** Append-only (no overwrites without explicit UUID)

---

## üéØ Best Practices

### **For Framework Maintainers**

1. **Treat framework collections as cache** - True source of truth is markdown
2. **Reindex after doc changes** - `make index-framework` after commits
3. **Never manually edit Qdrant** - Always update markdown and reindex
4. **Test hook enforcement** - Verify protection hook blocks writes

### **For Agents**

1. **Respect read-only collections** - Don't attempt to write to framework collections
2. **Request approval before storage** - Present patterns for user review
3. **Use proper taxonomy** - Follow `templates/pattern-taxonomy-guide.md`
4. **Focus on cross-project value** - Only store patterns applicable to 2+ projects

### **For Users**

1. **Review before approving** - Verify pattern accuracy and appropriateness
2. **Backup intelligence collection** - `make backup` regularly
3. **Reindex after doc changes** - Keep collections in sync with markdown
4. **Monitor storage requests** - Ensure quality of curated knowledge

---

## üîç Troubleshooting

### **Agent claims it can't write to collection**

**Issue:** Agent tries to write to `hish_framework_mpnet` or similar
**Cause:** Protection hook is working correctly
**Solution:** Agent should use `cross_project_intelligence` collection instead

### **Framework collection is outdated**

**Issue:** Documentation changes not reflected in queries
**Cause:** Collection not reindexed after markdown changes
**Solution:** Run `make index-framework` to rebuild

### **Lost patterns after reindexing**

**Issue:** Stored patterns disappeared after running `make index`
**Cause:** Accidentally wrote to framework collection before hooks were enforced
**Solution:**
- Ensure hooks are installed (`make setup-hooks`)
- Restore from backup if available
- Re-extract patterns from implementation and re-store to `cross_project_intelligence`

### **Hook not enforcing protection**

**Issue:** Agent can write to framework collections
**Cause:** Hooks not properly installed
**Solution:**
```bash
make setup-hooks
cat ~/.cursor/hooks.json  # Verify beforeMCPExecution is configured
ls -la ~/.cursor/hooks/protect_framework_collection  # Verify hook exists
```

---

## üìñ Related Documentation

- **Pattern Storage:** `templates/pattern-taxonomy-guide.md`
- **Synopsis Generation:** `templates/file-synopsis-workflows.md`
- **Hook Implementation:** `.cursor/hooks/protect_framework_collection`
- **Setup Instructions:** `docs/setup/getting-started.md`

---

**Last Updated:** 2025-10-10
